<contacts-page-toolbar #toolbar [forceIconMode]="forceToolbarIcons()">
  @if (!toolbar.mode()) {
    <!-- Calculating layout... -->
  }
  @else if (toolbar.mode() === 'full') {
    <div class="flex gap-2">
      <a
        matButton="tonal"
        color="primary"
        routerLink="new"
        data-testid="new-contact-button"
        class="toolbar-tonal-button"
      >
        New Contact
      </a>
      <a
        matButton="tonal"
        color="primary"
        routerLink="group-new"
        data-testid="new-group-button"
        class="toolbar-tonal-button"
      >
        New Group
      </a>
    </div>
  } @else {
    <div class="flex gap-2">
      <a
        mat-icon-button
        color="primary"
        routerLink="new"
        data-testid="new-contact-button"
        aria-label="New Contact"
      >
        <mat-icon>person_add</mat-icon>
      </a>
      <a
        mat-icon-button
        color="primary"
        routerLink="group-new"
        data-testid="new-group-button"
        aria-label="New Group"
      >
        <mat-icon>group_add</mat-icon>
      </a>
    </div>
  }
</contacts-page-toolbar>

<!-- 
  MAIN LAYOUT 
  If 'full' mode (wide) AND not forced sidebar -> Split View (Flex Row).
-->
<div 
  [class.flex]="toolbar.mode() === 'full' && !forceSidebar()" 
  class="h-full overflow-hidden"
>
  
  <!-- LEFT PANE (List) -->
  <div 
    [class.w-1/3]="toolbar.mode() === 'full' && !forceSidebar()" 
    [class.border-r]="toolbar.mode() === 'full' && !forceSidebar()" 
    class="h-full flex flex-col"
  >
    <mat-tab-group
      class="mat-tab-icon-button flex-1"
      animationDuration="0ms"
      [selectedIndex]="tabIndex()"
      (selectedTabChange)="onTabChange($event)"
    >
      <mat-tab label="Contacts">
        <ng-template matTabContent>
          <div class="pt-2 h-full overflow-y-auto">
            <!-- Check if contacts() is defined -->
            @if (contacts(); as list) {
              <contacts-list
                [contacts]="list"
                [selectedId]="selectedId()"
                (contactSelected)="onContactSelect($event, toolbar.mode() === 'full')"
              />
            } @else {
              <div class="flex items-center justify-center h-full text-gray-400">
                <div class="animate-pulse flex flex-col items-center">
                  <div class="h-4 w-32 bg-gray-200 rounded mb-2"></div>
                  <div class="h-3 w-24 bg-gray-200 rounded"></div>
                </div>
              </div>
            }
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab label="Groups">
        <ng-template matTabContent>
          <div class="pt-2 h-full overflow-y-auto">
            <!-- Check if groups() is defined -->
            @if (groups(); as list) {
              <contacts-group-list
                [groups]="groups()"
                [selectedId]="selectedId()"
                (groupSelected)="onGroupSelect($event, toolbar.mode() === 'full')"
              />
            } @else {
              <div class="flex items-center justify-center h-full text-gray-400">
                <div class="animate-pulse flex flex-col items-center">
                  <div class="h-4 w-32 bg-gray-200 rounded mb-2"></div>
                  <div class="h-3 w-24 bg-gray-200 rounded"></div>
                </div>
              </div>
            }
          </div>
        </ng-template>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon 
            class="text-gray-600" 
            matTooltip="Manage Requests & Blocks"
          >
            shield
          </mat-icon>
        </ng-template>

        <ng-template matTabContent>
          <div class="p-4 space-y-6 h-full overflow-y-auto">
            <contacts-pending-list 
              [pending]="pending()"
              (approve)="approveIdentity($event)"
              (block)="blockPending($event)"
            />
            <contacts-blocked-list
              [blocked]="blocked()"
              (unblock)="unblockIdentity($event)"
            />
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- RIGHT PANE (Detail) -->
  <!-- Visible only if Wide AND Not Forced Sidebar -->
  @if (toolbar.mode() === 'full' && !forceSidebar()) {
    <div class="flex-1 h-full overflow-y-auto bg-gray-50">
      
      <!-- Derived State: Active Contact -->
      @if (activeContact(); as contact) {
        <div class="p-4 h-full">
          <contacts-detail 
            [contactId]="contact.id"
            [startInEditMode]="false"
            (saved)="selectedId()" 
          />
        </div>
      } 
      <!-- Derived State: Active Group -->
      @else if (activeGroup(); as group) {
        <div class="p-8 text-center text-gray-500">
          <mat-icon class="text-6xl h-16 w-16 mb-4">group</mat-icon>
          <h2 class="text-xl font-bold mb-2">{{ group.name }}</h2>
          <p>Group details view pending implementation.</p>
        </div>
      } 
      <!-- Default State -->
      @else {
        <div class="h-full flex flex-col items-center justify-center text-gray-400">
          <mat-icon class="text-6xl h-16 w-16 mb-4">contacts</mat-icon>
          <p class="text-lg">Select a contact to view details</p>
        </div>
      }
    </div>
  }
</div>