<form [formGroup]="form" (ngSubmit)="onSave()" class="space-y-4 p-4">
  <mat-form-field
    [floatLabel]="'always'"
    class="w-full"
    [hideRequiredMarker]="!isEditing()"
  >
    <mat-label>Group Name</mat-label>
    <input matInput formControlName="name" />
  </mat-form-field>

  <mat-form-field [floatLabel]="'always'" class="w-full">
    <mat-label>Description</mat-label>
    <textarea
      matInput
      formControlName="description"
      rows="3"
    ></textarea>
  </mat-form-field>

  <div>
    <label class="font-medium text-sm text-gray-700">Members</label>
    @if (isEditing()) {
    <contacts-multi-selector
      class="mt-1"
      [allContacts]="allContacts()"
      [selectedIds]="form.get('contactIds')?.value"
      (selectedIdsChange)="form.get('contactIds')?.setValue($event)"
    />
    } @else {
    <div
      class="mt-1 border rounded-md overflow-hidden"
      style="max-height: 300px; overflow-y: auto;"
    >
      @for (contact of groupMembers(); track trackContactById($index, contact)) {
      <div
        class="flex items-center p-3 space-x-3 border-b last:border-b-0 bg-gray-50"
      >
        <contacts-avatar
          [profilePictureUrl]="getProfilePicture(contact)"
          [initials]="getInitials(contact)"
        ></contacts-avatar>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900 truncate">
            {{ contact.alias }}
          </div>
          <div class="text-sm text-gray-500 truncate">
            {{ contact.firstName }} {{ contact.surname }}
          </div>
        </div>
      </div>
      } @empty {
      <div class="p-4 text-center text-gray-500">
        No members in this group.
      </div>
      }
    </div>
    }
  </div>

  @if (isEditing()) {
  <div class="flex justify-end gap-2 pt-4">
    <button
      type="button"
      (click)="onCancel()"
      mat-button
      data-testid="cancel-button"
    >
      Cancel
    </button>
    <button
      type="submit"
      [disabled]="form.invalid"
      mat-flat-button
      color="primary"
      data-testid="save-button"
    >
      Save Group
    </button>
  </div>
  } @else {
  <div class="flex justify-end gap-2 pt-4">
    <button
      type="button"
      (click)="isEditing.set(true)"
      mat-flat-button
      color="primary"
      data-testid="edit-button"
    >
      Edit
    </button>
  </div>
  }
</form>