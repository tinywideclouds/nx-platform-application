<form class="space-y-4 p-4" (submit)="$event.preventDefault()">
  <mat-form-field
    [floatLabel]="'always'"
    class="w-full max-w-lg block"
    [hideRequiredMarker]="!isEditing()"
  >
    <mat-label>Group Name</mat-label>
    <input
      aria-label="Group Name"
      id="group-name-input"
      matInput
      [value]="name()"
      (input)="name.set($any($event.target).value)"
      (blur)="nameTouched.set(true)"
      [readonly]="!isEditing()"
    />
    @if (nameTouched() && nameError()) {
      <mat-error>{{ nameError() }}</mat-error>
    }
  </mat-form-field>

  <mat-form-field [floatLabel]="'always'" class="w-full max-w-lg block">
    <mat-label>Description</mat-label>
    <textarea
      aria-label="Description"
      matInput
      rows="3"
      [value]="description()"
      (input)="description.set($any($event.target).value)"
      [readonly]="!isEditing()"
    ></textarea>
  </mat-form-field>

  <div class="max-w-lg">
    <label class="font-medium text-sm text-gray-700">Members</label>
    @if (isEditing()) {
      <contacts-multi-selector
        class="mt-1"
        [allContacts]="allContacts()"
        [selectedIds]="contactIds()"
        (selectedIdsChange)="contactIds.set($event)"
      />
    } @else {
      <div class="mt-1 border rounded-md overflow-hidden group-form">
        @for (
          contact of groupMembers();
          track trackContactById($index, contact)
        ) {
          <div
            class="flex items-center gap-3 p-2 hover:bg-gray-50 border-b last:border-0"
          >
            <contacts-avatar
              [initials]="getInitials(contact)"
              class="h-8 w-8 text-xs"
            />
            <span class="text-sm font-medium">{{ contact.alias }}</span>
          </div>
        } @empty {
          <div class="p-4 text-center text-gray-400 text-sm">No members</div>
        }
      </div>
    }
  </div>

  @if (isEditing()) {
    <div
      class="flex justify-between items-center pt-4 border-t border-gray-100 max-w-lg"
    >
      @if (group() && !startInEditMode()) {
        <button
          type="button"
          mat-button
          color="warn"
          (click)="onDelete()"
          data-testid="delete-button"
        >
          <mat-icon>delete</mat-icon> Delete Group
        </button>
      } @else {
        <div></div>
      }

      <div class="flex gap-2 items-center">
        <button
          type="button"
          (click)="onCancel()"
          mat-button
          data-testid="cancel-button"
        >
          Cancel
        </button>

        <div [matTooltip]="saveTooltip()">
          <button
            type="button"
            (click)="onSave()"
            mat-flat-button
            color="primary"
            data-testid="save-button"
            [disabled]="!hasAnyContent()"
            [class.opacity-50]="hasAnyContent() && !isValid()"
          >
            Save Group
          </button>
        </div>
      </div>
    </div>

    @if (group() && linkedChildrenCount() > 0) {
      <div
        class="mt-4 p-3 bg-red-50 border border-red-100 rounded flex items-start gap-3 max-w-lg"
      >
        <mat-icon class="text-red-500 mt-0.5 text-lg">info</mat-icon>
        <div class="flex-1">
          <p class="text-sm text-red-800 font-medium mb-1">
            Linked Network Chats
          </p>
          <p class="text-xs text-red-600 mb-2">
            This group is used as a template for
            {{ linkedChildrenCount() }} active chats.
          </p>
          <mat-checkbox
            [checked]="deleteRecursive()"
            (change)="deleteRecursive.set($event.checked)"
            color="warn"
          >
            <span class="text-sm">Delete linked chats as well</span>
          </mat-checkbox>
        </div>
      </div>
    }
  } @else {
    <div class="flex justify-end gap-2 pt-4 max-w-lg">
      <button
        type="button"
        mat-stroked-button
        color="primary"
        (click)="isEditing.set(true)"
        data-testid="edit-button"
      >
        <mat-icon>edit</mat-icon> Edit Group
      </button>
    </div>
  }
</form>
