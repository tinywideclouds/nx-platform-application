<div class="h-full flex flex-col bg-white">
  <contacts-page-toolbar #toolbar>
    @if (showAddActions()) { @if (toolbar.mode() === 'full') {
    <div class="flex gap-2">
      <a
        mat-stroked-button
        color="primary"
        routerLink="."
        [queryParams]="{ new: 'contact' }"
        queryParamsHandling="merge"
        >New Contact</a
      >
      <a
        mat-stroked-button
        color="primary"
        routerLink="."
        [queryParams]="{ new: 'group' }"
        queryParamsHandling="merge"
        >New Group</a
      >
    </div>
    } @else {
    <div class="flex gap-2">
      <a
        mat-icon-button
        color="primary"
        routerLink="."
        [queryParams]="{ new: 'contact' }"
        queryParamsHandling="merge"
        ><mat-icon>person_add</mat-icon></a
      >
      <a
        mat-icon-button
        color="primary"
        routerLink="."
        [queryParams]="{ new: 'group' }"
        queryParamsHandling="merge"
        ><mat-icon>group_add</mat-icon></a
      >
    </div>
    } }
  </contacts-page-toolbar>

  <mat-tab-group
    class="mat-tab-icon-button flex-1 h-full overflow-hidden"
    animationDuration="0ms"
    [selectedIndex]="tabIndex()"
    (selectedTabChange)="onTabChange($event)"
  >
    <mat-tab label="Contacts">
      <div class="h-full overflow-y-auto pt-2">
        @if (contacts(); as list) {
        <contacts-list
          [contacts]="list"
          [selectedId]="selectedId()"
          (contactSelected)="contactSelected.emit($event)"
        />
        }
      </div>
    </mat-tab>

    <mat-tab label="Groups">
      <div class="h-full overflow-y-auto pt-2">
        @if (groups(); as list) {
        <contacts-group-list
          [groups]="list"
          [selectedId]="selectedId()"
          (groupSelected)="groupSelected.emit($event)"
        />
        }
      </div>
    </mat-tab>

    @if (!selectionMode()) {
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>shield</mat-icon>
      </ng-template>

      <div class="p-4 space-y-6 h-full overflow-y-auto">
        <mat-expansion-panel [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title class="flex items-center gap-2">
              <mat-icon class="text-blue-500">cloud_sync</mat-icon>
              Cloud Sync (Google)
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="flex flex-col gap-4 py-2">
            <button
              mat-flat-button
              color="primary"
              (click)="backupToCloud()"
              [disabled]="isBackingUp()"
            >
              @if (isBackingUp()) {
              <span class="flex items-center gap-2">
                <mat-spinner diameter="18"></mat-spinner>
                <span>Backing up...</span>
              </span>
              } @else {
              <span class="flex items-center gap-2">
                <mat-icon>backup</mat-icon>
                <span>Backup Now</span>
              </span>
              }
            </button>

            <mat-divider></mat-divider>

            <h4 class="text-sm font-medium text-gray-500">Available Backups</h4>

            <mat-list>
              @for (backup of cloudBackups(); track backup.fileId) {
              <mat-list-item>
                <mat-icon matListItemIcon>description</mat-icon>
                <div matListItemTitle>{{ backup.name }}</div>
                <div matListItemLine>
                  {{ backup.createdAt | date : 'short' }}
                </div>
                <button
                  mat-icon-button
                  matListItemMeta
                  (click)="restoreBackup(backup.fileId)"
                  [disabled]="isRestoring()"
                  matTooltip="Restore this backup"
                >
                  <mat-icon>restore</mat-icon>
                </button>
              </mat-list-item>
              } @empty {
              <div class="text-sm text-gray-400 italic text-center py-2">
                No backups found.
              </div>
              }
            </mat-list>
          </div>
        </mat-expansion-panel>

        <contacts-pending-list
          [pending]="pending()"
          (approve)="approveIdentity($event)"
          (block)="blockPending($event)"
        />
      </div>
    </mat-tab>
    }
  </mat-tab-group>
</div>
