<form
  [formGroup]="form"
  (ngSubmit)="onSave()"
  class="space-y-4 p-4 form-view-mode"
>
  <mat-form-field
    [floatLabel]="'always'"
    [hideRequiredMarker]="!isEditing()"
    class="w-full"
  >
    <mat-label>First Name</mat-label>
    <input aria-label="first name" matInput formControlName="firstName" />
    @if (form.get('firstName')?.hasError('required')) {
      <mat-error>First name is required</mat-error>
    }
  </mat-form-field>

  <mat-form-field
    [floatLabel]="'always'"
    [hideRequiredMarker]="!isEditing()"
    class="w-full"
  >
    <mat-label>Surname</mat-label>
    <input aria-label="surname" matInput formControlName="surname" />
  </mat-form-field>

  <mat-form-field
    [floatLabel]="'always'"
    [hideRequiredMarker]="!isEditing()"
    class="w-full"
  >
    <mat-label>Alias</mat-label>
    <input aria-label="alias" matInput formControlName="alias" />
    @if (form.get('alias')?.hasError('required')) {
      <mat-error>Alias is required</mat-error>
    }
  </mat-form-field>

  <mat-form-field
    [floatLabel]="'always'"
    [hideRequiredMarker]="!isEditing()"
    class="w-full"
  >
    <mat-label>Primary Email</mat-label>
    <input aria-label="email" matInput formControlName="email" />
    @if (form.get('email')?.hasError('required')) {
      <mat-error>Email is required</mat-error>
    }
    @if (form.get('email')?.hasError('email')) {
      <mat-error>Invalid email address</mat-error>
    }
  </mat-form-field>

  @if (linkedIdentities().length > 0) {
    <div class="pt-2">
      <label class="text-sm font-medium text-gray-700 block mb-2"
        >Linked Identities</label
      >
      <mat-chip-listbox aria-label="Linked identities">
        @for (urn of linkedIdentities(); track urn.toString()) {
          <mat-chip data-testid="identity-chip" class="identity-chip">
            <mat-icon matChipAvatar>account_circle</mat-icon>
            <span class="font-medium"
              >{{ getProviderName(urn) | titlecase }}:
            </span>
            <span>{{ getProviderId(urn) }}</span>
          </mat-chip>
        }
      </mat-chip-listbox>
    </div>
  }

  @if (!readonly()) {
    @if (isEditing()) {
      <div class="flex justify-between items-center pt-4">
        @if (contact() && !startInEditMode()) {
          <button
            type="button"
            mat-button
            color="warn"
            (click)="onDelete()"
            class="!text-red-600"
            data-testid="delete-button"
          >
            <mat-icon>delete</mat-icon> Delete Contact
          </button>
        } @else {
          <div></div>
        }

        <div class="flex gap-2">
          <button
            type="button"
            (click)="onCancel()"
            mat-button
            data-testid="cancel-button"
          >
            Cancel
          </button>
          <button
            type="submit"
            [disabled]="form.invalid"
            mat-flat-button
            color="primary"
            data-testid="save-button"
          >
            Save
          </button>
        </div>
      </div>
    } @else {
      <div class="flex justify-end gap-2 pt-4">
        <button
          type="button"
          mat-stroked-button
          color="primary"
          (click)="isEditing.set(true)"
          data-testid="edit-button"
        >
          <mat-icon>edit</mat-icon> Edit
        </button>
      </div>
    }
  }
</form>
