<form [formGroup]="form" (ngSubmit)="onSave()" class="space-y-4 p-4 form-view-mode">
  <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="w-full">
    <mat-label>First Name</mat-label>
    <input matInput formControlName="firstName" />
  </mat-form-field>

  <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="w-full">
    <mat-label>Surname</mat-label>
    <input matInput formControlName="surname" />
  </mat-form-field>

  <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="w-full">
    <mat-label>Alias</mat-label>
    <input matInput formControlName="alias" />
  </mat-form-field>

  <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="w-full">
    <mat-label>Primary Email</mat-label>
    <input matInput formControlName="email" type="email" />
  </mat-form-field>

  <div formArrayName="phoneNumbers">
    <h3 class="font-medium text-gray-700">Phone Numbers</h3>
    
    @for (phone of phoneNumbers.controls; track phone; let i = $index) {
      <div class="flex gap-2 mb-2 items-center">
        <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="flex-1">
          <mat-label>Phone Number</mat-label>
          <input matInput [formControlName]="i" />
        </mat-form-field>
        
        @if (isEditing()) {
          <button
            type="button"
            (click)="removePhoneNumber(i)"
            mat-icon-button
            color="warn"
            aria-label="Remove phone number"
            data-testid="remove-phone"
          >
            <mat-icon>delete</mat-icon>
          </button>
        }
      </div>
    }

    @if (isEditing()) {
      <button type="button" (click)="addPhoneNumber()" mat-stroked-button data-testid="add-phone">
        Add Phone
      </button>
    }
  </div>

  <div formArrayName="emailAddresses">
    <h3 class="font-medium text-gray-700">Other Emails</h3>
    
    @for (email of emailAddresses.controls; track email; let i = $index) {
      <div class="flex gap-2 mb-2 items-center">
        <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="!isEditing()" class="flex-1">
          <mat-label>Email Address</mat-label>
          <input matInput [formControlName]="i" type="email" />
        </mat-form-field>
        
        @if (isEditing()) {
          <button
            type="button"
            (click)="removeEmailAddress(i)"
            mat-icon-button
            color="warn"
            aria-label="Remove email address"
            data-testid="remove-email"
          >
            <mat-icon>delete</mat-icon>
          </button>
        }
      </div>
    }

    @if (isEditing()) {
      <button type="button" (click)="addEmailAddress()" mat-stroked-button data-testid="add-email">
        Add Email
      </button>
    }
  </div>

  

  @if (linkedIdentities().length > 0) {
    <div class="mt-4">
      <h3 class="font-medium text-gray-700 mb-2">Linked Accounts</h3>
      <mat-chip-listbox aria-label="Linked Identities">
        @for (urn of linkedIdentities(); track urn.toString()) {
          <mat-chip data-testid="identity-chip">
            <span class="font-bold">{{ getProviderName(urn) | titlecase }}: </span>
            <span>{{ getProviderId(urn) }}</span>
          </mat-chip>
        }
      </mat-chip-listbox>
    </div>
  }

  @if (isEditing()) {
  <div class="flex justify-end gap-2 pt-4">
    <button
      type="button"
      (click)="onCancel()"
      mat-button
      data-testid="cancel-button"
    >
      Cancel
    </button>
    <button
      type="submit"
      [disabled]="form.invalid"
      mat-flat-button
      color="primary"
      data-testid="save-button"
    >
      Save
    </button>
  </div>
  } @else {
  <div class="flex justify-end gap-2 pt-4">
    <button
      type="button"
      (click)="isEditing.set(true)"
      mat-flat-button
      color="primary"
      data-testid="edit-button"
    >
      Edit
    </button>
  </div>
  }
</form>