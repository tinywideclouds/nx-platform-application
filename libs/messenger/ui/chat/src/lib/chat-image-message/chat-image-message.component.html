<div
  class="relative group overflow-hidden rounded-lg border border-gray-200/20 bg-gray-100 inline-block"
  [matBadge]="'HD'"
  [matBadgeHidden]="!mediaLinks()"
  matBadgePosition="above after"
  matBadgeSize="large"
  matBadgeColor="accent"
>
  <img
    alt="image"
    [src]="displaySrc() | safeUrl"
    [alt]="altText()"
    class="chat-image block object-cover"
    loading="lazy"
  />

  @if (mediaLinks()) {
    <div
      class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-sm z-10"
    >
      @if (capabilities().canEmbed) {
        <button
          type="button"
          (click)="openPreview()"
          class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-colors"
          title="Quick View"
        >
          <mat-icon>visibility</mat-icon>
        </button>
      }

      @if (capabilities().canLinkExternal) {
        <button
          type="button"
          (click)="openExternal()"
          class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-colors"
          title="Open in Drive"
        >
          <mat-icon>open_in_new</mat-icon>
        </button>
      }
    </div>
  }

  @if (activePreviewUrl()) {
    <div class="absolute inset-0 z-20 bg-black">
      <button
        (click)="closePreview()"
        class="absolute top-2 right-2 text-white bg-black/50 rounded-full p-1 hover:bg-black/80 z-30"
      >
        <mat-icon>close</mat-icon>
      </button>
      <iframe
        title="preview frame"
        [src]="activePreviewUrl() | safeResourceUrl"
        class="w-full h-full border-0"
        allow="autoplay"
      >
      </iframe>
    </div>

    <div
      class="absolute bottom-0 inset-x-0 p-8 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 ease-out z-30"
    >
      <button
        type="button"
        (click)="updateThumbnail()"
        [disabled]="isUpdatingThumbnail()"
        class="flex items-center gap-3 px-6 py-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/10 text-white font-medium shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-wait"
      >
        @if (isUpdatingThumbnail()) {
          <mat-icon class="animate-spin">sync</mat-icon>
          <span>Processing...</span>
        } @else {
          <mat-icon>photo_size_select_large</mat-icon>
          <span>Set as HD Thumbnail</span>
        }
      </button>
    </div>
  }

  @if (capabilities().canDownload && !activePreviewUrl()) {
    <div
      class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-10"
    >
      <button
        type="button"
        (click)="downloadOriginal($event)"
        class="p-2 bg-black/40 hover:bg-black/60 rounded-full text-white backdrop-blur-sm transition-colors"
        title="Download Original"
      >
        <mat-icon>download</mat-icon>
      </button>
    </div>
  }

  @if (parts().length > 0) {
    <div
      class="bg-black/60 text-white text-xs p-2 absolute bottom-0 w-full backdrop-blur-md z-10"
    >
      <chat-text-renderer [parts]="parts()" />
    </div>
  }
</div>
