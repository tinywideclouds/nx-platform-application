<div
  class="relative group overflow-hidden rounded-lg border border-gray-200/20 bg-gray-100 inline-block"
  [matBadge]="'HD'"
  [matBadgeHidden]="!mediaLinks()"
  matBadgePosition="above after"
  matBadgeSize="large"
  matBadgeColor="accent"
>
  <img
    alt="inline image"
    [src]="displaySrc()"
    [alt]="altText()"
    class="chat-image block object-cover"
    loading="lazy"
  />

  @if (mediaLinks()) {
    <div
      class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-sm"
    >
      @if (capabilities().canEmbed) {
        <button
          (click)="openPreview()"
          class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-colors"
          title="Quick View"
        >
          <mat-icon>visibility</mat-icon>
        </button>
      }

      @if (capabilities().canLinkExternal) {
        <button
          (click)="openExternal()"
          class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-colors"
          title="Open in Drive"
        >
          <mat-icon>open_in_new</mat-icon>
        </button>
      }
    </div>
  }

  @if (content().caption; as caption) {
    <div
      class="bg-black/40 text-white text-xs p-2 absolute bottom-0 w-full backdrop-blur-sm"
    >
      {{ caption }}
    </div>
  }

  @if (activePreviewUrl(); as url) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"
      (click)="closePreview()"
    >
      <div
        class="relative w-full max-w-4xl h-[80vh] bg-white rounded-lg overflow-hidden shadow-2xl"
        (click)="$event.stopPropagation()"
      >
        <div class="absolute top-0 right-0 p-2 z-10">
          <button
            (click)="closePreview()"
            class="bg-black/50 text-white rounded-full p-1 hover:bg-black/70"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>

        @if (preferDownload) {
          <img
            [src]="activePreviewUrl() | safeUrl"
            class="w-full h-full object-contain rounded shadow-2xl bg-black/90"
            alt="Preview"
          />
        } @else {
          <iframe
            title="image frame"
            [src]="url | safeResourceUrl"
            class="w-full h-full border-0"
            allow="autoplay"
          >
          </iframe>
        }

        <div
          class="absolute bottom-0 inset-x-0 p-8 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 ease-out"
        >
          <button
            (click)="updateThumbnail()"
            [disabled]="isUpdatingThumbnail()"
            class="flex items-center gap-3 px-6 py-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/10 text-white font-medium shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-wait"
          >
            <mat-icon
              class="animate-spin"
              *ngIf="isUpdatingThumbnail(); else staticIcon"
              >sync</mat-icon
            >
            <ng-template #staticIcon
              ><mat-icon>photo_size_select_large</mat-icon></ng-template
            >

            <span>{{
              isUpdatingThumbnail() ? 'Processing...' : 'Set as HD Thumbnail'
            }}</span>
          </button>
        </div>

        @if (capabilities().canDownload) {
          <button
            (click)="downloadOriginal($event)"
            class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-colors"
            title="Quick View"
          >
            <mat-icon>download</mat-icon>
          </button>
        }
      </div>
    </div>
  }
</div>
