<div class="flex flex-col h-full bg-white relative">
  <main
    #messageContainer
    [appAutoScroll]="chatMessages()"
    [shouldForceScroll]="isMyMessage"
    (alertVisibility)="onAlertVisibility($event)"
    #autoScroll="appAutoScroll"
    class="flex-grow overflow-y-auto px-4 pt-4 pb-2 space-y-2 bg-gray-50 scroll-smooth"
  >
    <div class="mx-auto max-w-sm min-h-full flex flex-col w-full">
      @if (chatMessages().length === 0 && isLoading()) {
        <div
          class="flex-grow flex flex-col items-center justify-center text-gray-400"
        >
          <mat-spinner diameter="32"></mat-spinner>
          <p class="text-xs mt-3 font-medium">Loading history...</p>
        </div>
      } @else if (chatMessages().length === 0) {
        <div
          class="flex-grow flex flex-col items-center justify-center text-gray-400"
        >
          <p>No messages yet.</p>
          <p class="text-sm">Say hello! ðŸ‘‹</p>
        </div>
      } @else {
        @if (isLoading()) {
          <div class="flex justify-center py-2">
            <mat-spinner diameter="20" class="opacity-50"></mat-spinner>
          </div>
        }

        @for (msg of chatMessages(); track msg.id; let i = $index) {
          @if (shouldShowDateDivider(msg, i)) {
            <chat-message-divider
              type="date"
              [label]="(msg.sentTimestamp | date: 'mediumDate') || ''"
            />
          }
          @if (shouldShowNewMessagesDivider(msg)) {
            <chat-message-divider type="new-messages" label="New Messages" />
          }

          <div
            class="flex w-full mb-1 transition-all"
            [class.justify-end]="isMyMessage(msg)"
            [class.justify-start]="!isMyMessage(msg)"
          >
            @switch (msg.typeId.toString()) {
              @case (MSG_TYPE_TEXT) {
                <div class="relative max-w-[85%] group">
                  <chat-message-bubble
                    [direction]="isMyMessage(msg) ? 'outbound' : 'inbound'"
                    [timestamp]="msg.sentTimestamp"
                    [status]="msg.status"
                    [isBroadcast]="isBroadcast(msg)"
                    [isGhost]="isGhost(msg)"
                    [statusTooltip]="getReceiptSummary(msg)"
                    (retry)="onRetryMessage(msg)"
                  >
                    <chat-message-renderer
                      [payload]="{ kind: 'text', text: msg.textContent || '' }"
                      (action)="onContentAction($event)"
                    />
                  </chat-message-bubble>

                  @if (getReadCursorsForMessage(msg.id).length > 0) {
                    <div
                      class="absolute top-0 z-10 cursor-container flex flex-col space-y-1"
                      [class.right-full]="isMyMessage(msg)"
                      [class.mr-2]="isMyMessage(msg)"
                      [class.left-full]="!isMyMessage(msg)"
                      [class.ml-2]="!isMyMessage(msg)"
                    >
                      @for (
                        urn of getReadCursorsForMessage(msg.id);
                        track urn.toString()
                      ) {
                        <div
                          class="cursor-avatar looking-right"
                          [matTooltip]="'' + (urn | contactName)"
                          matTooltipPosition="above"
                        >
                          ðŸ‘€
                        </div>
                      }
                    </div>
                  }
                </div>
              }

              @case (MSG_TYPE_INVITE) {
                <div class="max-w-[85%]">
                  <messenger-chat-invite-message
                    [payload]="getInviteViewModel(msg)"
                    (accept)="onAcceptInvite(msg)"
                    (reject)="onRejectInvite(msg)"
                  />
                  <div
                    class="text-[10px] text-gray-400 mt-1 px-1"
                    [class.text-right]="isMyMessage(msg)"
                  >
                    {{ msg.sentTimestamp | date: 'shortTime' }}
                  </div>
                </div>
              }

              @default {
                <div
                  class="p-3 rounded-lg bg-gray-200 text-gray-500 text-xs italic border border-gray-300"
                >
                  Unsupported message type
                </div>
              }
            }
          </div>
        }
      }

      <div
        class="min-h-[2rem] py-2 flex flex-col justify-end transition-all duration-200"
      >
        @if (showTypingIndicator()) {
          <div class="animate-fade-in">
            <chat-typing-indicator />
          </div>
        }
      </div>
    </div>
  </main>

  <messenger-chat-input (send)="onSendMessage($event)" (typing)="onTyping()" />
</div>
