<div class="h-full flex flex-col bg-gray-50">
  <div
    class="bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm z-10"
  >
    <div>
      <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
        <mat-icon class="text-warn-500">gpp_maybe</mat-icon>
        Message Requests
      </h1>
      <p class="text-sm text-gray-500">
        {{ requests().length }} unknown sender{{
          requests().length === 1 ? '' : 's'
        }}
      </p>
    </div>

    @if (requests().length > 0) {
      <button mat-flat-button color="warn" (click)="blockAll.emit()">
        <mat-icon>block</mat-icon> Block All
      </button>
    }
  </div>

  <div class="flex-1 overflow-y-auto p-4">
    @if (requests().length > 0) {
      <mat-accordion displayMode="flat" multi="false">
        @for (req of requests(); track req.urn.toString()) {
          <mat-expansion-panel
            class="mb-2 border border-gray-200 rounded-lg overflow-hidden"
            (opened)="onPanelOpened(req.urn)"
          >
            <mat-expansion-panel-header class="h-16">
              <div class="flex items-center gap-4 w-full">
                <div
                  class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 flex-shrink-0"
                >
                  <mat-icon>person_outline</mat-icon>
                </div>

                <div class="flex-1 min-w-0">
                  <div
                    class="font-medium text-gray-900 truncate"
                    [title]="req.urn.toString()"
                  >
                    {{ req.urn.toString() }}
                  </div>
                  <div class="text-xs text-gray-500">
                    Attempted contact: {{ req.firstSeenAt | date: 'medium' }}
                  </div>
                </div>
              </div>
            </mat-expansion-panel-header>

            <div class="pt-4 pb-2">
              <div
                class="flex flex-wrap gap-3 mb-6 p-3 bg-gray-50 rounded-lg border border-gray-100"
              >
                <button
                  mat-flat-button
                  color="primary"
                  class="flex-1"
                  (click)="accept.emit(req.urn)"
                >
                  <mat-icon>person_add</mat-icon> Add Contact
                </button>

                <button
                  mat-stroked-button
                  class="flex-1"
                  (click)="peek.emit(req.urn)"
                  [disabled]="loadingPreviews().has(req.urn.toString())"
                >
                  @if (loadingPreviews().has(req.urn.toString())) {
                    <ng-container>
                      <mat-icon class="animate-spin">sync</mat-icon>
                      <span>Loading...</span>
                    </ng-container>
                  } @else {
                    <ng-container>
                      <mat-icon>visibility</mat-icon>
                      <span>Show Messages</span>
                    </ng-container>
                  }
                </button>

                <button
                  mat-stroked-button
                  class="flex-1"
                  (click)="dismiss.emit(req.urn)"
                >
                  <mat-icon>delete</mat-icon> Dismiss
                </button>

                <button
                  mat-stroked-button
                  color="warn"
                  class="flex-1"
                  (click)="block.emit({ urn: req.urn, scope: 'messenger' })"
                >
                  <mat-icon>block</mat-icon> Block
                </button>
              </div>

              @if (previewMessages()[req.urn.toString()] !== undefined) {
                @if (getMessagesFor(req.urn).length > 0) {
                  <div class="border-t border-gray-100 pt-4 animate-fade-in">
                    <h3
                      class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"
                    >
                      Quarantined Messages
                    </h3>

                    <div class="space-y-2">
                      @for (msg of getMessagesFor(req.urn); track msg.id) {
                        <div
                          class="bg-gray-100 p-3 rounded-lg rounded-tl-none text-sm text-gray-800"
                        >
                          {{ msg.textContent }}
                        </div>
                        <div class="text-[10px] text-gray-400 pl-1">
                          {{ msg.sentTimestamp | date: 'shortTime' }}
                        </div>
                      }
                    </div>
                  </div>
                } @else {
                  <div
                    class="border-t border-gray-100 pt-6 pb-2 text-center text-gray-400 text-sm italic animate-fade-in"
                  >
                    <mat-icon class="text-gray-300 mb-1">inbox</mat-icon>
                    <p>No message content found in quarantine.</p>
                  </div>
                }
              }
            </div>
          </mat-expansion-panel>
        }
      </mat-accordion>
    } @else {
      <div
        class="flex flex-col items-center justify-center h-64 text-gray-400 mt-10"
      >
        <div
          class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4"
        >
          <mat-icon class="text-4xl text-gray-300">verified_user</mat-icon>
        </div>
        <p class="font-medium">No pending requests</p>
        <p class="text-sm opacity-75">Strangers will appear here.</p>
      </div>
    }
  </div>
</div>
