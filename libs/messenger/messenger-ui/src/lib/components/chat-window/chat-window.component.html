<!-- This component fills the h-screen container from the router-outlet -->
<div class="flex flex-col h-full">
  @if (participant(); as p) {
  <!-- 1. Header -->
  <header
    class="flex-shrink-0 flex items-center p-3 border-b bg-white z-10"
  >
    <!-- Back Button (Mobile Only) -->
    <button
      (click)="onBack()"
      class="md:hidden mr-2 p-2 rounded-full hover:bg-gray-100"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        ></path>
      </svg>
    </button>

    <!-- Avatar -->
    <div
      role="img"
      class="relative flex h-10 w-10 items-center justify-center rounded-full overflow-hidden bg-gray-600 text-white"
    >
      @if (p.profilePictureUrl) {
      <img
        [src]="p.profilePictureUrl"
        [alt]="p.name"
        class="h-full w-full object-cover"
      />
      } @else {
      <span data-testid="initials" class="text-base font-medium">
        {{ p.initials }}
      </span>
      }
    </div>

    <!-- Name -->
    <div class="ml-3">
      <div class="font-medium text-gray-900 truncate">{{ p.name }}</div>
      <!-- We could add an "online" status here later -->
      <!-- <div class="text-sm text-gray-500">Online</div> -->
    </div>
  </header>

  <!-- 2. Message List -->
  <main
    #messageContainer
    class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50"
  >
    @for (msg of messages(); track msg.id) {
    <!-- Determine if message is incoming or outgoing -->
    @if (msg.senderId.toString() === currentUserUrn()?.toString()) {
    <!-- Outgoing Message (from me) -->
    <div class="flex justify-end">
      <div
        class="max-w-xs lg:max-w-md p-3 rounded-lg bg-blue-600 text-white shadow"
      >
        <p class="text-sm">{{ msg.textContent }}</p>
        <div class="text-xs text-blue-100 text-right mt-1">
          {{ msg.timestamp | date : "shortTime" }}
        </div>
      </div>
    </div>
    } @else {
    <!-- Incoming Message (from other) -->
    <div class="flex justify-start">
      <div
        class="max-w-xs lg:max-w-md p-3 rounded-lg bg-white text-gray-800 shadow border"
      >
        <p class="text-sm">{{ msg.textContent }}</p>
        <div class="text-xs text-gray-500 text-right mt-1">
          {{ msg.timestamp | date : "shortTime" }}
        </div>
      </div>
    </div>
    } }
  </main>

  <!-- 3. Message Input Footer -->
  <footer class="flex-shrink-0 p-3 border-t bg-white">
    <div class="flex items-center space-x-2">
      <input
        type="text"
        [(ngModel)]="newMessageText"
        (keydown.enter)="onSendMessage()"
        placeholder="Type a message..."
        class="flex-grow p-3 border rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        (click)="onSendMessage()"
        class="flex-shrink-0 p-3 rounded-full bg-blue-600 text-white hover:bg-blue-700"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
      </button>
    </div>
  </footer>
  } @else {
  <!-- Placeholder for when no conversation is selected -->
  <div class="flex items-center justify-center h-full text-gray-500">
    <p>Select a conversation to start chatting.</p>
  </div>
  }
</div>