<div class="flex flex-col h-full bg-white relative">
  <main
    #messageContainer
    [appAutoScroll]="messagesVM()"
    [shouldForceScroll]="isMyMessage"
    (alertVisibility)="onAlertVisibility($event)"
    #autoScroll="appAutoScroll"
    class="flex-grow overflow-y-auto p-4 space-y-2 bg-gray-50 scroll-smooth"
  >
    <div class="mx-auto max-w-sm min-h-full flex flex-col">
      @if (messagesVM().length === 0 && isLoading()) {
      <div
        class="flex-grow flex flex-col items-center justify-center text-gray-400"
      >
        <mat-spinner diameter="32"></mat-spinner>
        <p class="text-xs mt-3 font-medium">Loading history...</p>
      </div>
      } @else if (messagesVM().length === 0) {
      <div
        class="flex-grow flex flex-col items-center justify-center text-gray-400"
      >
        <p>No messages yet.</p>
        <p class="text-sm">Say hello! ðŸ‘‹</p>
      </div>
      } @else { @if (isLoading()) {
      <div class="flex justify-center py-2">
        <mat-spinner diameter="20" class="opacity-50"></mat-spinner>
      </div>
      } @for (msg of messagesVM(); track msg.id; let i = $index) { @if
      (shouldShowDateDivider(msg, i)) {
      <chat-message-divider
        type="date"
        [label]="(msg.sentTimestamp | date : 'mediumDate') || ''"
      />
      } @if (shouldShowNewMessagesDivider(msg)) {
      <chat-message-divider type="new-messages" label="New Messages" />
      }

      <chat-message-bubble
        [direction]="isMyMessage(msg) ? 'outbound' : 'inbound'"
        [timestamp]="msg.sentTimestamp"
        [status]="msg.status"
      >
        <chat-message-renderer
          [payload]="msg.contentPayload"
          (action)="onContentAction($event)"
        />
      </chat-message-bubble>
      } } @if (showTypingIndicator()) {
      <div class="py-2 animate-fade-in">
        <chat-typing-indicator />
      </div>
      }
    </div>
  </main>

  <footer class="flex-shrink-0 p-3 border-t bg-white z-10">
    <div class="flex items-center space-x-2">
      <input
        type="text"
        [value]="messageText()"
        (input)="onMessageInput($event)"
        (keydown.enter)="onSendMessage()"
        placeholder="Type a message..."
        class="flex-grow p-3 border rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
      />
      <button
        title="send"
        (click)="onSendMessage()"
        class="flex-shrink-0 p-3 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-sm"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
      </button>
    </div>
  </footer>
</div>
